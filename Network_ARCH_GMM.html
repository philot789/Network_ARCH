<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Raffaele Mattera, Philipp Otto">

<title>Network log-ARCH models for forecasting stock market volatility</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="Network_ARCH_GMM_files/libs/clipboard/clipboard.min.js"></script>
<script src="Network_ARCH_GMM_files/libs/quarto-html/quarto.js"></script>
<script src="Network_ARCH_GMM_files/libs/quarto-html/popper.min.js"></script>
<script src="Network_ARCH_GMM_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Network_ARCH_GMM_files/libs/quarto-html/anchor.min.js"></script>
<link href="Network_ARCH_GMM_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Network_ARCH_GMM_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Network_ARCH_GMM_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Network_ARCH_GMM_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Network_ARCH_GMM_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Network log-ARCH models for forecasting stock market volatility</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Raffaele Mattera, Philipp Otto </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="network-log-arch-models-for-forecasting-stock-market-volatility" class="level2">
<h2 class="anchored" data-anchor-id="network-log-arch-models-for-forecasting-stock-market-volatility">Network log-ARCH models for forecasting stock market volatility</h2>
<p>Code used in:<br>
Network log-ARCH models for forecasting stock market volatility (arXiv:xxxx.xxxxx)<br>
Raffaele Mattera, Philipp Otto</p>
</section>
<section id="abstract" class="level2">
<h2 class="anchored" data-anchor-id="abstract">Abstract</h2>
<p>This paper presents a novel dynamic network autoregressive conditional heteroscedasticity (ARCH) model based on spatiotemporal ARCH models to forecast volatility in the US stock market. To improve the forecasting accuracy, the model integrates temporally lagged volatility information and information from adjacent nodes, which may instantaneously spill across the entire network. The model is also suitable for high-dimensional cases where multivariate ARCH models are typically no longer applicable. We adopt the theoretical foundations from spatiotemporal statistics and transfer the dynamic ARCH model for processes to networks. This new approach is compared with independent univariate log-ARCH models. We could quantify the improvements due to the instantaneous network ARCH effects, which are studied for the first time in this paper. The edges are determined based on various distance and correlation measures between the time series. The performances of the alternative networksâ€™ definitions are compared in terms of out-of-sample accuracy. Furthermore, we consider ensemble forecasts based on different network definitions.</p>
</section>
<section id="model" class="level2">
<h2 class="anchored" data-anchor-id="model">Model</h2>
<p>The new dynamic network log-ARCH model is based on dynamic spatiotemporal ARCH models proposed by . As for the univariate log-ARCH models, the observed process is given by <span class="math display">\[\begin{align}
    Y_{t}(s_i) &amp; = \sqrt{h_{t}(s_i)} \varepsilon_{t}(s_i), \label{eq:network_arch_Y}
\end{align}\]</span> but now <span class="math inline">\(h_{t}(s_i)\)</span> is being influenced by past observations at the same node, <span class="math inline">\(Y_{t-1}(s_i)\)</span>, and simultaneously by the adjacent observations at the same time point, <span class="math inline">\(\{Y_{t}(s_j) : j \in E_i \}\)</span>, where <span class="math inline">\(E_i\)</span> is the subset of edges with links to node <span class="math inline">\(s_i\)</span>. Let <span class="math inline">\(\boldsymbol{h}^*_t = (\ln h^2_t(s_1), \ldots, \ln h^2_t(s_n))'\)</span> and <span class="math inline">\(\boldsymbol{Y}^*_t = (\ln Y^2_t(s_1), \ldots, \ln Y^2_t(s_n))'\)</span>. Then, the network log-ARCH process of order one can be written as follows <span class="math display">\[\begin{align}
\boldsymbol{h}^*_t =  \boldsymbol{\omega} + \mathbf{\Gamma} \boldsymbol{Y}^*_{t-1} + \rho \mathbf{W} \boldsymbol{Y}^*_t  \, , \label{eq:network_arch_h}
\end{align}\]</span> where <span class="math inline">\(\mathbf{W} = (w_{ij})_{i,j = 1, \ldots, n}\)</span> is a matrix of edge weights, which define the relative degree of the volatility spillovers, <span class="math inline">\(\rho\)</span> is an unknown parameter for these instantaneous network interactions, <span class="math inline">\(\mathbf{\Gamma} = \text{diag}(\gamma_1, \ldots, \gamma_n)'\)</span> is a diagonal matrix of stock-specific temporal ARCH effects, and <span class="math inline">\(\boldsymbol{\omega} = (\omega_1, \ldots, \omega_n)'\)</span> is the constant term. The matrix of edge weights <span class="math inline">\(\mathbf{W}\)</span> is analogously specified as the spatial weight matrix in spatial econometrics. That is, the diagonal entries are supposed to be zero (i.e., no self-loops), the matrix is non-stochastic, and uniformly bounded in row and column sums in absolute terms. The latter assumption is needed to limit the network interactions to a constant degree when the number of nodes <span class="math inline">\(n\)</span> is increasing. Typical choices are inverse-distance matrices (e.g., for road networks) or <span class="math inline">\(k\)</span>-nearest neighbours matrices, where the proximity is defined by any network characteristic. We will discuss the definition of <span class="math inline">\(\mathbf{W}\)</span> in more detail below.</p>
</section>
<section id="functions-for-gmm-estimation" class="level2">
<h2 class="anchored" data-anchor-id="functions-for-gmm-estimation">Functions for GMM estimation</h2>
<p>Note that the examples showing how the functions can be used are in the next section.</p>
<div class="cell">
<details>
<summary>Show the functions needed for the GMM estimator of the network log-ARCH model</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>GMM_SDPD_2SLS_ARCH_ind_timelags <span class="ot">&lt;-</span> <span class="cf">function</span>(Y, X, W, info){</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  ksy <span class="ot">=</span> info<span class="sc">$</span>ksy <span class="co"># spatial exapansion order of y</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  ksx <span class="ot">=</span> info<span class="sc">$</span>ksx <span class="co"># spatial exapansion order of x</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(Y)){</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Y is missing"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># if(is.null(X)){</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># stop("X is missing")</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># }</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(W)){</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"W is missing"</span>)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">is.null</span>(info)){</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"info is missing"</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  dimW <span class="ot">&lt;-</span> <span class="fu">dim</span>(W)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  n    <span class="ot">&lt;-</span> dimW[<span class="dv">1</span>]</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(dimW) <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    new.W <span class="ot">&lt;-</span> <span class="fu">array</span>(, <span class="at">dim =</span> <span class="fu">c</span>(n,n,p))</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    new.W[,,<span class="dv">1</span>] <span class="ot">&lt;-</span> W</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    W <span class="ot">&lt;-</span> new.W</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> dimW[<span class="dv">3</span>]</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">length</span>(dimW) <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">|</span>  dimW[<span class="dv">1</span>] <span class="sc">!=</span>  dimW[<span class="dv">2</span>] <span class="sc">|</span> dimW[<span class="dv">2</span>] <span class="sc">!=</span>  n){</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Check W matrix (W must be of dimension n x n x p)"</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="fu">dim</span>(Y)[<span class="dv">1</span>] <span class="sc">!=</span> n <span class="sc">|</span> <span class="fu">length</span>(<span class="fu">dim</span>(Y)) <span class="sc">!=</span> <span class="dv">2</span>){</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Y should be a matrix of dimension n x T"</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">dim</span>(Y)[<span class="dv">2</span>] <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cat("Number of cross-sectional units:", n,  "\n")</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cat("Length of the time series:", t,  "\n")</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>  <span class="co"># cat("Number of spatial lags (weight matrices):", p,  "\n")</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  s  <span class="ot">&lt;-</span> t <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  nt <span class="ot">&lt;-</span> n <span class="sc">*</span> t</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  ns <span class="ot">&lt;-</span> n <span class="sc">*</span> s</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>  yt   <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(Y[, <span class="dv">2</span><span class="sc">:</span>(t<span class="sc">+</span><span class="dv">1</span>)])</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  ytlv <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(Y[, <span class="dv">1</span><span class="sc">:</span>(t)]) <span class="co"># ytl vector</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>  ytl  <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(nt,n)) <span class="co"># ytl matrix to get individual temporal coefficients</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>  ysl  <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(nt,p))</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>  ystl <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(nt,p))</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    ytl[<span class="fu">seq</span>(<span class="dv">1</span>, nt, <span class="at">by =</span> n) <span class="sc">+</span> i <span class="sc">-</span> <span class="dv">1</span>, i] <span class="ot">&lt;-</span> Y[i, <span class="dv">1</span><span class="sc">:</span>(t)]</span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>t){</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>      ysl[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n), j]  <span class="ot">&lt;-</span> W[,,j] <span class="sc">%*%</span> yt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n)];</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>      ystl[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n), j] <span class="ot">&lt;-</span> W[,,j] <span class="sc">%*%</span> ytlv[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n)];</span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(info<span class="sc">$</span>stl <span class="sc">+</span> info<span class="sc">$</span>tl <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>    xw <span class="ot">&lt;-</span> <span class="fu">cbind</span>(ytl, ystl);</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (info<span class="sc">$</span>stl <span class="sc">+</span> info<span class="sc">$</span>tl <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(info<span class="sc">$</span>stl <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>      xw <span class="ot">&lt;-</span> ystl</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>      xw <span class="ot">&lt;-</span> ytl</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (info<span class="sc">$</span>stl <span class="sc">+</span> info<span class="sc">$</span>tl <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"No spatial and no temporal lag given"</span>)</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Double-Check stl &amp; tl # in Info structure"</span>)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>  X_stacked <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>  W1hx <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>  MHX <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(X)){</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>t){</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>      X_stacked <span class="ot">&lt;-</span> <span class="fu">rbind</span>(X_stacked, X[,i<span class="sc">+</span><span class="dv">1</span>,])</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(<span class="fu">dim</span>(X)[<span class="dv">3</span>] <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>      X_stacked <span class="ot">&lt;-</span> <span class="fu">array</span>(X_stacked, <span class="at">dim =</span> <span class="fu">c</span>(<span class="fu">length</span>(X_stacked), <span class="dv">1</span>))</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>  xs  <span class="ot">&lt;-</span> X_stacked;</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>  xt  <span class="ot">&lt;-</span> <span class="fu">cbind</span>(xw, xs);</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>  zt  <span class="ot">&lt;-</span> <span class="fu">cbind</span>(ysl, xt);</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>  kz  <span class="ot">&lt;-</span> <span class="fu">dim</span>(zt)[<span class="dv">2</span>]</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>  kx  <span class="ot">&lt;-</span> <span class="fu">dim</span>(xt)[<span class="dv">2</span>]</span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>  kxs <span class="ot">&lt;-</span> <span class="fu">dim</span>(xs)[<span class="dv">2</span>]</span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>  kxw <span class="ot">&lt;-</span> <span class="fu">dim</span>(xw)[<span class="dv">2</span>]</span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>  c <span class="ot">&lt;-</span> <span class="fu">sqrt</span>((t<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>s))<span class="sc">/</span>(t<span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span>s)<span class="sc">+</span><span class="dv">1</span>)); </span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  F <span class="ot">&lt;-</span> <span class="fu">diag</span>(t)</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  F <span class="ot">&lt;-</span> F[, <span class="dv">1</span><span class="sc">:</span>(t<span class="dv">-1</span>)]</span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(t<span class="dv">-1</span>)){</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>    F[(i<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>t, i] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span>(t<span class="sc">-</span>i);</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>    F[, i]        <span class="ot">&lt;-</span> c[i] <span class="sc">*</span> F[,i];</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>  hyt  <span class="ot">&lt;-</span> <span class="fu">array</span>(yt, <span class="at">dim =</span> <span class="fu">c</span>(n,t));</span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>  hyt  <span class="ot">&lt;-</span> hyt <span class="sc">%*%</span> F;</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>  hyt  <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(hyt);</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>  hytlv <span class="ot">&lt;-</span> <span class="fu">array</span>(ytlv, <span class="at">dim =</span> <span class="fu">c</span>(n,t));</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>  hytlv <span class="ot">&lt;-</span> hytlv <span class="sc">%*%</span> F;</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>  hytlv <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(hytlv);</span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>  hytl  <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(ns,n)) <span class="co"># hytl matrix to get individual temporal coefficients</span></span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n){</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>    hytl[<span class="fu">seq</span>(<span class="dv">1</span>, ns, <span class="at">by =</span> n) <span class="sc">+</span> i <span class="sc">-</span> <span class="dv">1</span>, i] <span class="ot">&lt;-</span> <span class="fu">array</span>(hytlv, <span class="at">dim =</span> <span class="fu">c</span>(n,s))[i, ]</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>  hysl <span class="ot">&lt;-</span> <span class="fu">array</span>(ysl, <span class="at">dim =</span> <span class="fu">c</span>(n,t,p));</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>  hysltemp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(n,t<span class="dv">-1</span>,p));</span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>    hysltemp[,,i] <span class="ot">&lt;-</span> hysl[,,i] <span class="sc">%*%</span> F;</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>  hysl <span class="ot">&lt;-</span> <span class="fu">array</span>(hysltemp, <span class="at">dim =</span> <span class="fu">c</span>(ns,p));</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>  hystl <span class="ot">&lt;-</span> <span class="fu">array</span>(ystl, <span class="at">dim =</span> <span class="fu">c</span>(n,t,p));</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>  hystltemp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(n,t<span class="dv">-1</span>,p));</span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>    hystltemp[,,i] <span class="ot">&lt;-</span> hystl[,,i] <span class="sc">%*%</span> F;</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>  hystl <span class="ot">&lt;-</span> <span class="fu">array</span>(hystltemp, <span class="at">dim =</span> <span class="fu">c</span>(ns,p));</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(X_stacked)){</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>    kx <span class="ot">&lt;-</span> <span class="fu">dim</span>(X_stacked)[<span class="dv">2</span>]</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>    hx <span class="ot">&lt;-</span> <span class="fu">array</span>(X_stacked, <span class="at">dim =</span> <span class="fu">c</span>(n,t,kx));</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>    hxtemp <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(n,t<span class="dv">-1</span>,kx));</span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>kx){</span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>      hxtemp[,,i] <span class="ot">&lt;-</span> hx[,,i] <span class="sc">%*%</span> F;</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>    hx <span class="ot">&lt;-</span> <span class="fu">array</span>(hxtemp, <span class="at">dim =</span> <span class="fu">c</span>(ns,kx));</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>    hx <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(info<span class="sc">$</span>stl <span class="sc">+</span> info<span class="sc">$</span>tl <span class="sc">==</span> <span class="dv">2</span>){</span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>    hxw <span class="ot">&lt;-</span> <span class="fu">cbind</span>(hytl, hystl);</span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(info<span class="sc">$</span>stl <span class="sc">+</span> info<span class="sc">$</span>tl <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(info<span class="sc">$</span>stl <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>      hxw <span class="ot">&lt;-</span> hystl</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>      hxw <span class="ot">&lt;-</span> hytl</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span>(info<span class="sc">$</span>stl <span class="sc">+</span> info<span class="sc">$</span>tl <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"no spatial and temporal lag given, check suitability"</span>)</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(<span class="st">"Doube-check info$stl and info$tl"</span>)</span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>  pyid     <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(ksy,<span class="dv">2</span>));</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>  pa       <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>  pb       <span class="ot">&lt;-</span> p</span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>  pyid[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(pa, pb);</span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>ksy){</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>    pa <span class="ot">&lt;-</span> pa <span class="sc">+</span> p<span class="sc">^</span>(k<span class="dv">-1</span>)</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>    pb <span class="ot">&lt;-</span> pb <span class="sc">+</span> p<span class="sc">^</span>k</span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>    pyid[k,] <span class="ot">&lt;-</span> <span class="fu">c</span>(pa, pb);</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>  WY <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(nt, pyid[ksy,<span class="dv">2</span>]));</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>  WY[, <span class="dv">1</span><span class="sc">:</span>p] <span class="ot">=</span> ystl</span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>t){</span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(ksy<span class="dv">-1</span>)){</span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>        WY[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n), (pyid[k,<span class="dv">2</span>] <span class="sc">+</span> <span class="dv">1</span> <span class="sc">+</span> (j<span class="dv">-1</span>)<span class="sc">*</span>p<span class="sc">^</span>k)<span class="sc">:</span>(pyid[k,<span class="dv">2</span>]<span class="sc">+</span>j<span class="sc">*</span>p<span class="sc">^</span>k)] <span class="ot">&lt;-</span> W[,,j] <span class="sc">%*%</span> WY[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n), pyid[k,<span class="dv">1</span>]<span class="sc">:</span>pyid[k,<span class="dv">2</span>]];</span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(X_stacked)){</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>    kx <span class="ot">&lt;-</span> <span class="fu">dim</span>(X_stacked)[<span class="dv">2</span>]</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>    W1hx <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(ns,kx<span class="sc">*</span>p))</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>s){</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>        W1hx[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n), (<span class="dv">1</span><span class="sc">+</span>(j<span class="dv">-1</span>)<span class="sc">*</span>kx)<span class="sc">:</span>(j<span class="sc">*</span>kx)] <span class="ot">&lt;-</span> W[,,j] <span class="sc">%*%</span> hx[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),];</span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>    pxid <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(ksx,<span class="dv">2</span>))</span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>    pa       <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>    pb       <span class="ot">&lt;-</span> p<span class="sc">*</span>kx</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>    pxid[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(pa, pb);</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>ksx){</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>      pa <span class="ot">&lt;-</span> pa <span class="sc">+</span> p<span class="sc">^</span>(k<span class="dv">-1</span>)<span class="sc">*</span>kx</span>
<span id="cb1-199"><a href="#cb1-199" aria-hidden="true" tabindex="-1"></a>      pb <span class="ot">&lt;-</span> pb <span class="sc">+</span> p<span class="sc">^</span>k<span class="sc">*</span>kx</span>
<span id="cb1-200"><a href="#cb1-200" aria-hidden="true" tabindex="-1"></a>      pxid[k,] <span class="ot">&lt;-</span> <span class="fu">c</span>(pa, pb);</span>
<span id="cb1-201"><a href="#cb1-201" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-202"><a href="#cb1-202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-203"><a href="#cb1-203" aria-hidden="true" tabindex="-1"></a>    WHX <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(ns, pxid[ksx,<span class="dv">2</span>]<span class="sc">*</span>kx))</span>
<span id="cb1-204"><a href="#cb1-204" aria-hidden="true" tabindex="-1"></a>    WHX[,<span class="dv">1</span><span class="sc">:</span>(p<span class="sc">*</span>kx)] <span class="ot">&lt;-</span> W1hx;</span>
<span id="cb1-205"><a href="#cb1-205" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>s){</span>
<span id="cb1-206"><a href="#cb1-206" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(ksx<span class="dv">-1</span>)){</span>
<span id="cb1-207"><a href="#cb1-207" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb1-208"><a href="#cb1-208" aria-hidden="true" tabindex="-1"></a>          WHX[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n), (pxid[k,<span class="dv">2</span>]<span class="sc">+</span><span class="dv">1</span><span class="sc">+</span>(j<span class="dv">-1</span>)<span class="sc">*</span>p<span class="sc">^</span>k<span class="sc">*</span>kx)<span class="sc">:</span>(pxid[k,<span class="dv">2</span>]<span class="sc">+</span>j<span class="sc">*</span>p<span class="sc">^</span>k<span class="sc">*</span>kx)] <span class="ot">&lt;-</span> W[,,j] <span class="sc">%*%</span> WHX[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n), pxid[k,<span class="dv">1</span>]<span class="sc">:</span>pxid[k,<span class="dv">2</span>]];</span>
<span id="cb1-209"><a href="#cb1-209" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-210"><a href="#cb1-210" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-211"><a href="#cb1-211" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-212"><a href="#cb1-212" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-213"><a href="#cb1-213" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-214"><a href="#cb1-214" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-215"><a href="#cb1-215" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Following is the IV without interaction term</span></span>
<span id="cb1-216"><a href="#cb1-216" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-217"><a href="#cb1-217" aria-hidden="true" tabindex="-1"></a>  pyid <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(ksy,<span class="dv">2</span>));</span>
<span id="cb1-218"><a href="#cb1-218" aria-hidden="true" tabindex="-1"></a>  pa   <span class="ot">&lt;-</span> <span class="dv">1</span>;</span>
<span id="cb1-219"><a href="#cb1-219" aria-hidden="true" tabindex="-1"></a>  pb   <span class="ot">&lt;-</span> p;</span>
<span id="cb1-220"><a href="#cb1-220" aria-hidden="true" tabindex="-1"></a>  pyid[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(pa, pb);</span>
<span id="cb1-221"><a href="#cb1-221" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>ksy){</span>
<span id="cb1-222"><a href="#cb1-222" aria-hidden="true" tabindex="-1"></a>    pa <span class="ot">&lt;-</span> pa <span class="sc">+</span> p</span>
<span id="cb1-223"><a href="#cb1-223" aria-hidden="true" tabindex="-1"></a>    pb <span class="ot">&lt;-</span> pb <span class="sc">+</span> p</span>
<span id="cb1-224"><a href="#cb1-224" aria-hidden="true" tabindex="-1"></a>    pyid[k,] <span class="ot">&lt;-</span> <span class="fu">c</span>(pa, pb)</span>
<span id="cb1-225"><a href="#cb1-225" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-226"><a href="#cb1-226" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-227"><a href="#cb1-227" aria-hidden="true" tabindex="-1"></a>  MY <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(nt, pyid[ksy,<span class="dv">2</span>]))</span>
<span id="cb1-228"><a href="#cb1-228" aria-hidden="true" tabindex="-1"></a>  MY[,<span class="dv">1</span><span class="sc">:</span>p] <span class="ot">&lt;-</span> ystl;</span>
<span id="cb1-229"><a href="#cb1-229" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-230"><a href="#cb1-230" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>t){</span>
<span id="cb1-231"><a href="#cb1-231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(ksy<span class="dv">-1</span>)){</span>
<span id="cb1-232"><a href="#cb1-232" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb1-233"><a href="#cb1-233" aria-hidden="true" tabindex="-1"></a>        MY[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n), (pyid[k,<span class="dv">2</span>]<span class="sc">+</span>j)<span class="sc">:</span>(pyid[k,<span class="dv">2</span>]<span class="sc">+</span>j)] <span class="ot">&lt;-</span> W[,,j] <span class="sc">%*%</span> MY[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n), (pyid[k,<span class="dv">1</span>]<span class="sc">-</span><span class="dv">1</span><span class="sc">+</span>j)<span class="sc">:</span>(pyid[k,<span class="dv">1</span>]<span class="sc">-</span><span class="dv">1</span><span class="sc">+</span>j)];</span>
<span id="cb1-234"><a href="#cb1-234" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-235"><a href="#cb1-235" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-236"><a href="#cb1-236" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-237"><a href="#cb1-237" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-238"><a href="#cb1-238" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(X_stacked)){</span>
<span id="cb1-239"><a href="#cb1-239" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-240"><a href="#cb1-240" aria-hidden="true" tabindex="-1"></a>    kx <span class="ot">&lt;-</span> <span class="fu">dim</span>(X_stacked)[<span class="dv">2</span>]</span>
<span id="cb1-241"><a href="#cb1-241" aria-hidden="true" tabindex="-1"></a>    pxid <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(ksx,<span class="dv">2</span>))</span>
<span id="cb1-242"><a href="#cb1-242" aria-hidden="true" tabindex="-1"></a>    pa <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-243"><a href="#cb1-243" aria-hidden="true" tabindex="-1"></a>    pb <span class="ot">&lt;-</span> p<span class="sc">*</span>kx</span>
<span id="cb1-244"><a href="#cb1-244" aria-hidden="true" tabindex="-1"></a>    pxid[<span class="dv">1</span>,] <span class="ot">&lt;-</span> <span class="fu">c</span>(pa, pb)</span>
<span id="cb1-245"><a href="#cb1-245" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>ksx){</span>
<span id="cb1-246"><a href="#cb1-246" aria-hidden="true" tabindex="-1"></a>      pa <span class="ot">&lt;-</span> pa <span class="sc">+</span> p<span class="sc">*</span>kx</span>
<span id="cb1-247"><a href="#cb1-247" aria-hidden="true" tabindex="-1"></a>      pb <span class="ot">&lt;-</span> pb <span class="sc">+</span> p<span class="sc">*</span>kx</span>
<span id="cb1-248"><a href="#cb1-248" aria-hidden="true" tabindex="-1"></a>      pxid[k, ] <span class="ot">&lt;-</span> <span class="fu">c</span>(pa, pb)</span>
<span id="cb1-249"><a href="#cb1-249" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-250"><a href="#cb1-250" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-251"><a href="#cb1-251" aria-hidden="true" tabindex="-1"></a>    MHX <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(ns,pyid[ksx,<span class="dv">2</span>]<span class="sc">*</span>kx));</span>
<span id="cb1-252"><a href="#cb1-252" aria-hidden="true" tabindex="-1"></a>    MHX[,<span class="dv">1</span><span class="sc">:</span>(p<span class="sc">*</span>kx)] <span class="ot">&lt;-</span> W1hx;</span>
<span id="cb1-253"><a href="#cb1-253" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>s){</span>
<span id="cb1-254"><a href="#cb1-254" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span>(k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(ksx<span class="dv">-1</span>)){</span>
<span id="cb1-255"><a href="#cb1-255" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb1-256"><a href="#cb1-256" aria-hidden="true" tabindex="-1"></a>          MHX[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),(pxid[k,<span class="dv">2</span>]<span class="sc">+</span><span class="dv">1</span><span class="sc">+</span>(j<span class="dv">-1</span>)<span class="sc">*</span>kx)<span class="sc">:</span>(pxid[k,<span class="dv">2</span>]<span class="sc">+</span>j<span class="sc">*</span>kx)] <span class="ot">&lt;-</span> W[,,j] <span class="sc">%*%</span> MHX[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),(pxid[k,<span class="dv">1</span>]<span class="sc">+</span>(j<span class="dv">-1</span>)<span class="sc">*</span>kx)<span class="sc">:</span>(pxid[k,<span class="dv">1</span>]<span class="sc">-</span><span class="dv">1</span><span class="sc">+</span>j<span class="sc">*</span>kx)];</span>
<span id="cb1-257"><a href="#cb1-257" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-258"><a href="#cb1-258" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-259"><a href="#cb1-259" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-260"><a href="#cb1-260" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-261"><a href="#cb1-261" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-262"><a href="#cb1-262" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-263"><a href="#cb1-263" aria-hidden="true" tabindex="-1"></a>  Qw     <span class="ot">&lt;-</span> <span class="fu">cbind</span>(ytl, WY);</span>
<span id="cb1-264"><a href="#cb1-264" aria-hidden="true" tabindex="-1"></a>  Qw_alt <span class="ot">&lt;-</span> <span class="fu">cbind</span>(ytl, MY);</span>
<span id="cb1-265"><a href="#cb1-265" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-266"><a href="#cb1-266" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(ksx <span class="sc">==</span> <span class="dv">0</span>){</span>
<span id="cb1-267"><a href="#cb1-267" aria-hidden="true" tabindex="-1"></a>    Qs     <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-268"><a href="#cb1-268" aria-hidden="true" tabindex="-1"></a>    Qs_alt <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb1-269"><a href="#cb1-269" aria-hidden="true" tabindex="-1"></a>    qs     <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-270"><a href="#cb1-270" aria-hidden="true" tabindex="-1"></a>    qs_alt <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb1-271"><a href="#cb1-271" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb1-272"><a href="#cb1-272" aria-hidden="true" tabindex="-1"></a>    Qs     <span class="ot">&lt;-</span> <span class="fu">cbind</span>(hx, W1hx)</span>
<span id="cb1-273"><a href="#cb1-273" aria-hidden="true" tabindex="-1"></a>    Qs_alt <span class="ot">&lt;-</span> <span class="fu">cbind</span>(hx, MHX)</span>
<span id="cb1-274"><a href="#cb1-274" aria-hidden="true" tabindex="-1"></a>    qs     <span class="ot">&lt;-</span> <span class="fu">dim</span>(Qs)[<span class="dv">2</span>]</span>
<span id="cb1-275"><a href="#cb1-275" aria-hidden="true" tabindex="-1"></a>    qs_slt <span class="ot">&lt;-</span> <span class="fu">dim</span>(Qs_alt)[<span class="dv">2</span>]</span>
<span id="cb1-276"><a href="#cb1-276" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-277"><a href="#cb1-277" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-278"><a href="#cb1-278" aria-hidden="true" tabindex="-1"></a>  Qw     <span class="ot">&lt;-</span> Qw[<span class="dv">1</span><span class="sc">:</span>ns,]</span>
<span id="cb1-279"><a href="#cb1-279" aria-hidden="true" tabindex="-1"></a>  Qw_alt <span class="ot">&lt;-</span> Qw_alt[<span class="dv">1</span><span class="sc">:</span>ns,]</span>
<span id="cb1-280"><a href="#cb1-280" aria-hidden="true" tabindex="-1"></a>  qw     <span class="ot">&lt;-</span> <span class="fu">dim</span>(Qw)[<span class="dv">2</span>]</span>
<span id="cb1-281"><a href="#cb1-281" aria-hidden="true" tabindex="-1"></a>  qw_alt <span class="ot">&lt;-</span> <span class="fu">dim</span>(Qw_alt)[<span class="dv">2</span>]</span>
<span id="cb1-282"><a href="#cb1-282" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-283"><a href="#cb1-283" aria-hidden="true" tabindex="-1"></a>  Q      <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Qw, Qs)</span>
<span id="cb1-284"><a href="#cb1-284" aria-hidden="true" tabindex="-1"></a>  Q_alt  <span class="ot">&lt;-</span> <span class="fu">cbind</span>(Qw_alt, Qs_alt)</span>
<span id="cb1-285"><a href="#cb1-285" aria-hidden="true" tabindex="-1"></a>  kq     <span class="ot">&lt;-</span> <span class="fu">dim</span>(Q)[<span class="dv">2</span>]</span>
<span id="cb1-286"><a href="#cb1-286" aria-hidden="true" tabindex="-1"></a>  kq_alt <span class="ot">&lt;-</span> <span class="fu">dim</span>(Q_alt)[<span class="dv">2</span>]</span>
<span id="cb1-287"><a href="#cb1-287" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-288"><a href="#cb1-288" aria-hidden="true" tabindex="-1"></a>  hxs <span class="ot">&lt;-</span> hx</span>
<span id="cb1-289"><a href="#cb1-289" aria-hidden="true" tabindex="-1"></a>  hxt <span class="ot">&lt;-</span> <span class="fu">cbind</span>(hxw, hxs)</span>
<span id="cb1-290"><a href="#cb1-290" aria-hidden="true" tabindex="-1"></a>  hzt <span class="ot">&lt;-</span> <span class="fu">cbind</span>(hysl, hxt)</span>
<span id="cb1-291"><a href="#cb1-291" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-292"><a href="#cb1-292" aria-hidden="true" tabindex="-1"></a>  Qhz <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(kq, kz))</span>
<span id="cb1-293"><a href="#cb1-293" aria-hidden="true" tabindex="-1"></a>  QQ  <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(kq, kq))</span>
<span id="cb1-294"><a href="#cb1-294" aria-hidden="true" tabindex="-1"></a>  Qhy <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(kq, <span class="dv">1</span>))</span>
<span id="cb1-295"><a href="#cb1-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-296"><a href="#cb1-296" aria-hidden="true" tabindex="-1"></a>  Qhz_alt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(kq_alt, kz))</span>
<span id="cb1-297"><a href="#cb1-297" aria-hidden="true" tabindex="-1"></a>  QQ_alt  <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(kq_alt, kq_alt))</span>
<span id="cb1-298"><a href="#cb1-298" aria-hidden="true" tabindex="-1"></a>  Qhy_alt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(kq_alt, <span class="dv">1</span>))</span>
<span id="cb1-299"><a href="#cb1-299" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-300"><a href="#cb1-300" aria-hidden="true" tabindex="-1"></a>  Jn <span class="ot">&lt;-</span> <span class="fu">diag</span>(n) <span class="sc">-</span> <span class="fu">array</span>(<span class="dv">1</span><span class="sc">/</span>n, <span class="at">dim =</span> <span class="fu">c</span>(n,n));</span>
<span id="cb1-301"><a href="#cb1-301" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-302"><a href="#cb1-302" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>s){</span>
<span id="cb1-303"><a href="#cb1-303" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(info<span class="sc">$</span>ted <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-304"><a href="#cb1-304" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-305"><a href="#cb1-305" aria-hidden="true" tabindex="-1"></a>      Qhz <span class="ot">&lt;-</span> Qhz <span class="sc">+</span> <span class="fu">t</span>(Q[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> Jn <span class="sc">%*%</span> hzt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),];</span>
<span id="cb1-306"><a href="#cb1-306" aria-hidden="true" tabindex="-1"></a>      QQ  <span class="ot">&lt;-</span> QQ  <span class="sc">+</span> <span class="fu">t</span>(Q[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> Jn <span class="sc">%*%</span> Q[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),];</span>
<span id="cb1-307"><a href="#cb1-307" aria-hidden="true" tabindex="-1"></a>      Qhy <span class="ot">&lt;-</span> Qhy <span class="sc">+</span> <span class="fu">t</span>(Q[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> Jn <span class="sc">%*%</span> hyt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n)];</span>
<span id="cb1-308"><a href="#cb1-308" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-309"><a href="#cb1-309" aria-hidden="true" tabindex="-1"></a>      Qhz_alt <span class="ot">&lt;-</span> Qhz_alt <span class="sc">+</span> <span class="fu">t</span>(Q_alt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> Jn <span class="sc">%*%</span> hzt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),];</span>
<span id="cb1-310"><a href="#cb1-310" aria-hidden="true" tabindex="-1"></a>      QQ_alt  <span class="ot">&lt;-</span> QQ_alt  <span class="sc">+</span> <span class="fu">t</span>(Q_alt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> Jn <span class="sc">%*%</span> Q_alt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),];</span>
<span id="cb1-311"><a href="#cb1-311" aria-hidden="true" tabindex="-1"></a>      Qhy_alt <span class="ot">&lt;-</span> Qhy_alt <span class="sc">+</span> <span class="fu">t</span>(Q_alt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> Jn <span class="sc">%*%</span> hyt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n)];</span>
<span id="cb1-312"><a href="#cb1-312" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-313"><a href="#cb1-313" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb1-314"><a href="#cb1-314" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-315"><a href="#cb1-315" aria-hidden="true" tabindex="-1"></a>      Qhz <span class="ot">&lt;-</span> Qhz <span class="sc">+</span> <span class="fu">t</span>(Q[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> hzt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),];</span>
<span id="cb1-316"><a href="#cb1-316" aria-hidden="true" tabindex="-1"></a>      QQ  <span class="ot">&lt;-</span> QQ  <span class="sc">+</span> <span class="fu">t</span>(Q[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> Q[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),];</span>
<span id="cb1-317"><a href="#cb1-317" aria-hidden="true" tabindex="-1"></a>      Qhy <span class="ot">&lt;-</span> Qhy <span class="sc">+</span> <span class="fu">t</span>(Q[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> hyt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n)];</span>
<span id="cb1-318"><a href="#cb1-318" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-319"><a href="#cb1-319" aria-hidden="true" tabindex="-1"></a>      Qhz_alt <span class="ot">&lt;-</span> Qhz_alt <span class="sc">+</span> <span class="fu">t</span>(Q_alt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> hzt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),];</span>
<span id="cb1-320"><a href="#cb1-320" aria-hidden="true" tabindex="-1"></a>      QQ_alt  <span class="ot">&lt;-</span> QQ_alt  <span class="sc">+</span> <span class="fu">t</span>(Q_alt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> Q_alt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),];</span>
<span id="cb1-321"><a href="#cb1-321" aria-hidden="true" tabindex="-1"></a>      Qhy_alt <span class="ot">&lt;-</span> Qhy_alt <span class="sc">+</span> <span class="fu">t</span>(Q_alt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n),]) <span class="sc">%*%</span> hyt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n)];</span>
<span id="cb1-322"><a href="#cb1-322" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-323"><a href="#cb1-323" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-324"><a href="#cb1-324" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-325"><a href="#cb1-325" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-326"><a href="#cb1-326" aria-hidden="true" tabindex="-1"></a>  theta <span class="ot">&lt;-</span> <span class="fu">mldivide</span>(<span class="fu">t</span>(Qhz) <span class="sc">%*%</span> <span class="fu">ginv</span>(QQ) <span class="sc">%*%</span> Qhz, <span class="fu">t</span>(Qhz) <span class="sc">%*%</span> <span class="fu">ginv</span>(QQ) <span class="sc">%*%</span> Qhy);</span>
<span id="cb1-327"><a href="#cb1-327" aria-hidden="true" tabindex="-1"></a>  theta_alt <span class="ot">&lt;-</span> <span class="fu">mldivide</span>(<span class="fu">t</span>(Qhz_alt) <span class="sc">%*%</span> <span class="fu">ginv</span>(QQ_alt) <span class="sc">%*%</span> Qhz_alt, <span class="fu">t</span>(Qhz_alt) <span class="sc">%*%</span> <span class="fu">ginv</span>(QQ_alt) <span class="sc">%*%</span> Qhy_alt);</span>
<span id="cb1-328"><a href="#cb1-328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-329"><a href="#cb1-329" aria-hidden="true" tabindex="-1"></a>  e <span class="ot">&lt;-</span> hyt <span class="sc">-</span> hzt <span class="sc">%*%</span> theta;</span>
<span id="cb1-330"><a href="#cb1-330" aria-hidden="true" tabindex="-1"></a>  e_alt <span class="ot">&lt;-</span> hyt <span class="sc">-</span> hzt <span class="sc">%*%</span> theta_alt;</span>
<span id="cb1-331"><a href="#cb1-331" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(info<span class="sc">$</span>ted <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb1-332"><a href="#cb1-332" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>s){</span>
<span id="cb1-333"><a href="#cb1-333" aria-hidden="true" tabindex="-1"></a>      e[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n)] <span class="ot">&lt;-</span> Jn <span class="sc">%*%</span> e[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n)];</span>
<span id="cb1-334"><a href="#cb1-334" aria-hidden="true" tabindex="-1"></a>      e_alt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n)] <span class="ot">&lt;-</span> Jn <span class="sc">%*%</span> e_alt[(<span class="dv">1</span><span class="sc">+</span>(i<span class="dv">-1</span>)<span class="sc">*</span>n)<span class="sc">:</span>(i<span class="sc">*</span>n)];</span>
<span id="cb1-335"><a href="#cb1-335" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb1-336"><a href="#cb1-336" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-337"><a href="#cb1-337" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-338"><a href="#cb1-338" aria-hidden="true" tabindex="-1"></a>  sigma2 <span class="ot">&lt;-</span> <span class="fu">mean</span>((e<span class="sc">-</span><span class="fu">mean</span>(e))<span class="sc">^</span><span class="dv">2</span>);</span>
<span id="cb1-339"><a href="#cb1-339" aria-hidden="true" tabindex="-1"></a>  sigma4 <span class="ot">&lt;-</span> <span class="fu">mean</span>((e<span class="sc">-</span><span class="fu">mean</span>(e))<span class="sc">^</span><span class="dv">4</span>);</span>
<span id="cb1-340"><a href="#cb1-340" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-341"><a href="#cb1-341" aria-hidden="true" tabindex="-1"></a>  sigma2_alt <span class="ot">&lt;-</span> <span class="fu">mean</span>((e_alt<span class="sc">-</span><span class="fu">mean</span>(e_alt))<span class="sc">^</span><span class="dv">2</span>);</span>
<span id="cb1-342"><a href="#cb1-342" aria-hidden="true" tabindex="-1"></a>  sigma4_alt <span class="ot">&lt;-</span> <span class="fu">mean</span>((e_alt<span class="sc">-</span><span class="fu">mean</span>(e_alt))<span class="sc">^</span><span class="dv">4</span>);</span>
<span id="cb1-343"><a href="#cb1-343" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-344"><a href="#cb1-344" aria-hidden="true" tabindex="-1"></a>  lambda <span class="ot">&lt;-</span> theta[<span class="dv">1</span><span class="sc">:</span>p];</span>
<span id="cb1-345"><a href="#cb1-345" aria-hidden="true" tabindex="-1"></a>  delta  <span class="ot">&lt;-</span> theta[(p<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>kz];</span>
<span id="cb1-346"><a href="#cb1-346" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-347"><a href="#cb1-347" aria-hidden="true" tabindex="-1"></a>  lambda_alt <span class="ot">&lt;-</span> theta_alt[<span class="dv">1</span><span class="sc">:</span>p];</span>
<span id="cb1-348"><a href="#cb1-348" aria-hidden="true" tabindex="-1"></a>  delta_alt  <span class="ot">&lt;-</span> theta_alt[p<span class="sc">+</span><span class="dv">1</span><span class="sc">:</span>kz];</span>
<span id="cb1-349"><a href="#cb1-349" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-350"><a href="#cb1-350" aria-hidden="true" tabindex="-1"></a>  lambdaW     <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(n,n));</span>
<span id="cb1-351"><a href="#cb1-351" aria-hidden="true" tabindex="-1"></a>  lambdaW_alt <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="dv">0</span>, <span class="at">dim =</span> <span class="fu">c</span>(n,n));</span>
<span id="cb1-352"><a href="#cb1-352" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>p){</span>
<span id="cb1-353"><a href="#cb1-353" aria-hidden="true" tabindex="-1"></a>    lambdaW     <span class="ot">&lt;-</span> lambdaW     <span class="sc">+</span> lambda[j] <span class="sc">*</span> W[,,j];</span>
<span id="cb1-354"><a href="#cb1-354" aria-hidden="true" tabindex="-1"></a>    lambdaW_alt <span class="ot">&lt;-</span> lambdaW_alt <span class="sc">+</span> lambda_alt[j] <span class="sc">*</span> W[,,j];</span>
<span id="cb1-355"><a href="#cb1-355" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-356"><a href="#cb1-356" aria-hidden="true" tabindex="-1"></a>  Sn <span class="ot">&lt;-</span> <span class="fu">diag</span>(n) <span class="sc">-</span> lambdaW;</span>
<span id="cb1-357"><a href="#cb1-357" aria-hidden="true" tabindex="-1"></a>  Sn_alt <span class="ot">&lt;-</span> <span class="fu">diag</span>(n) <span class="sc">-</span> lambdaW_alt;</span>
<span id="cb1-358"><a href="#cb1-358" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-359"><a href="#cb1-359" aria-hidden="true" tabindex="-1"></a>  DSiD <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(sigma2<span class="sc">*</span>ns) <span class="sc">*</span> <span class="fu">t</span>(Qhz) <span class="sc">%*%</span> <span class="fu">ginv</span>(QQ) <span class="sc">%*%</span> Qhz;</span>
<span id="cb1-360"><a href="#cb1-360" aria-hidden="true" tabindex="-1"></a>  DSiD_alt <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>(sigma2_alt<span class="sc">*</span>ns) <span class="sc">*</span> <span class="fu">t</span>(Qhz_alt) <span class="sc">%*%</span> <span class="fu">ginv</span>(QQ_alt) <span class="sc">%*%</span> Qhz_alt;</span>
<span id="cb1-361"><a href="#cb1-361" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-362"><a href="#cb1-362" aria-hidden="true" tabindex="-1"></a>  SIG <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="dv">1</span><span class="sc">/</span>ns <span class="sc">*</span> <span class="fu">solve</span>(DSiD), <span class="at">error =</span> <span class="cf">function</span>(e){<span class="fu">cat</span>(<span class="st">"DSiD not invertible </span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">return</span>(<span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(DSiD)))})</span>
<span id="cb1-363"><a href="#cb1-363" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SIG &lt;- 1/ns * solve(DSiD);</span></span>
<span id="cb1-364"><a href="#cb1-364" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-365"><a href="#cb1-365" aria-hidden="true" tabindex="-1"></a>  std <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">abs</span>(<span class="fu">diag</span>(SIG)));</span>
<span id="cb1-366"><a href="#cb1-366" aria-hidden="true" tabindex="-1"></a>  tstat <span class="ot">&lt;-</span> theta<span class="sc">/</span>std;</span>
<span id="cb1-367"><a href="#cb1-367" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-368"><a href="#cb1-368" aria-hidden="true" tabindex="-1"></a>  SIG_alt <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(<span class="dv">1</span><span class="sc">/</span>ns <span class="sc">*</span> <span class="fu">solve</span>(DSiD_alt), <span class="at">error =</span> <span class="cf">function</span>(e){<span class="fu">cat</span>(<span class="st">"DSiD_alt not invertible </span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">return</span>(<span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">dim</span>(DSiD_alt)))})</span>
<span id="cb1-369"><a href="#cb1-369" aria-hidden="true" tabindex="-1"></a>  <span class="co"># SIG_alt &lt;- 1/ns * solve(DSiD_alt);</span></span>
<span id="cb1-370"><a href="#cb1-370" aria-hidden="true" tabindex="-1"></a>  std_alt <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">abs</span>(<span class="fu">diag</span>(SIG_alt)));</span>
<span id="cb1-371"><a href="#cb1-371" aria-hidden="true" tabindex="-1"></a>  tstat_alt <span class="ot">&lt;-</span> theta_alt<span class="sc">/</span>std_alt;</span>
<span id="cb1-372"><a href="#cb1-372" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-373"><a href="#cb1-373" aria-hidden="true" tabindex="-1"></a>  results <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">theta =</span> theta, <span class="at">std =</span> std, <span class="at">SIG =</span> SIG, <span class="at">tstat =</span> tstat, <span class="at">sigma2 =</span> sigma2,</span>
<span id="cb1-374"><a href="#cb1-374" aria-hidden="true" tabindex="-1"></a>                  <span class="at">theta_alt =</span> theta_alt, <span class="at">std_alt =</span> std_alt, <span class="at">SIG_alt =</span> SIG_alt, <span class="at">tstat_alt =</span> tstat_alt, <span class="at">sigma2_alt =</span> sigma2_alt,</span>
<span id="cb1-375"><a href="#cb1-375" aria-hidden="true" tabindex="-1"></a>                  <span class="at">e =</span> <span class="fu">array</span>(e, <span class="at">dim =</span> <span class="fu">c</span>(n, t)), <span class="at">e_alt =</span> <span class="fu">array</span>(e_alt, <span class="at">dim =</span> <span class="fu">c</span>(n, t)), <span class="at">hyt =</span> <span class="fu">array</span>(hyt, <span class="at">dim =</span> <span class="fu">c</span>(n, t)))</span>
<span id="cb1-376"><a href="#cb1-376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-377"><a href="#cb1-377" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(results)</span>
<span id="cb1-378"><a href="#cb1-378" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-379"><a href="#cb1-379" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-380"><a href="#cb1-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-381"><a href="#cb1-381" aria-hidden="true" tabindex="-1"></a>mldivide <span class="ot">&lt;-</span> <span class="cf">function</span>(A, b){</span>
<span id="cb1-382"><a href="#cb1-382" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">ginv</span>(<span class="fu">t</span>(A) <span class="sc">%*%</span> A) <span class="sc">%*%</span> <span class="fu">t</span>(A) <span class="sc">%*%</span> b)</span>
<span id="cb1-383"><a href="#cb1-383" aria-hidden="true" tabindex="-1"></a>  <span class="co"># return(qr.solve(A, b))</span></span>
<span id="cb1-384"><a href="#cb1-384" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="download-data-set" class="level2">
<h2 class="anchored" data-anchor-id="download-data-set">Download data set</h2>
<p>For the empirical experiment, we consider a forecasting experiment on the stocks included in the Dow Jones Industrial Average Index. We excluded stocks showing missing values. The daily time series span from October 1, 2010, to October 31, 2022.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Packages</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"rio"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"BatchGetSymbols"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: rvest</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: dplyr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"cluster"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"TSclust"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: pdc</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Registered S3 method overwritten by 'quantmod':
  method            from
  as.zoo.data.frame zoo </code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"lgarch"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: zoo</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'zoo'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    as.Date, as.Date.numeric</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"MASS"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'MASS'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    select</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"doParallel"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: foreach</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: iterators</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: parallel</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"foreach"</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"lgarch"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Download data</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>DJIA.dat <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">"DJIA - composition at 2020.xlsx"</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>tickers <span class="ot">&lt;-</span> DJIA.dat<span class="sc">$</span>Symbol</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>start.date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2010-10-01"</span>)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>end.date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2022-10-31"</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>l.out <span class="ot">&lt;-</span> <span class="fu">BatchGetSymbols</span>(<span class="at">tickers =</span> tickers,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>                         <span class="at">first.date =</span> start.date, </span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>                         <span class="at">last.date =</span>  end.date, </span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>                         <span class="at">thresh.bad.data =</span> <span class="dv">1</span>, </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>                         <span class="at">bench.ticker =</span> <span class="st">"^GSPC"</span>,</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">type.return =</span> <span class="st">"log"</span>,</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>                         <span class="at">freq.data =</span> <span class="st">"daily"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: `BatchGetSymbols()` was deprecated in BatchGetSymbols 2.6.4.
â„¹ Please use `yfR::yf_get()` instead.
â„¹ 2022-05-01: Package BatchGetSymbols will soon be replaced by yfR.  More
  details about the change is available at github
  &lt;&lt;www.github.com/msperlin/yfR&gt; You can install yfR by executing:

remotes::install_github('msperlin/yfR')</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Running BatchGetSymbols for:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
   tickers =PG, MMM, IBM, MRK, AXP, MCD, BA, KO, CAT, DIS, JPM, JNJ, WMT, HD, INTC, MSFT, VZ, CVX, CSCO, TRV, UNH, GS, NKE, V, AAPL, WBA, DOW, AMGN, HON, CRM
   Downloading data for benchmark ticker
^GSPC | yahoo (1|1) | Not Cached | Saving cache
PG | yahoo (1|30) | Not Cached | Saving cache - Got 100% of valid prices | Good stuff!
MMM | yahoo (2|30) | Not Cached | Saving cache - Got 100% of valid prices | Looking good!
IBM | yahoo (3|30) | Not Cached | Saving cache - Got 100% of valid prices | You got it!
MRK | yahoo (4|30) | Not Cached | Saving cache - Got 100% of valid prices | You got it!
AXP | yahoo (5|30) | Not Cached | Saving cache - Got 100% of valid prices | Good job!
MCD | yahoo (6|30) | Not Cached | Saving cache - Got 100% of valid prices | Good stuff!
BA | yahoo (7|30) | Not Cached | Saving cache - Got 100% of valid prices | Got it!
KO | yahoo (8|30) | Not Cached | Saving cache - Got 100% of valid prices | Nice!
CAT | yahoo (9|30) | Not Cached | Saving cache - Got 100% of valid prices | Nice!
DIS | yahoo (10|30) | Not Cached | Saving cache - Got 100% of valid prices | Well done!
JPM | yahoo (11|30) | Not Cached | Saving cache - Got 100% of valid prices | Looking good!
JNJ | yahoo (12|30) | Not Cached | Saving cache - Got 100% of valid prices | Good job!
WMT | yahoo (13|30) | Not Cached | Saving cache - Got 100% of valid prices | OK!
HD | yahoo (14|30) | Not Cached | Saving cache - Got 100% of valid prices | Nice!
INTC | yahoo (15|30) | Not Cached | Saving cache - Got 100% of valid prices | Nice!
MSFT | yahoo (16|30) | Not Cached | Saving cache - Got 100% of valid prices | Looking good!
VZ | yahoo (17|30) | Not Cached | Saving cache - Got 100% of valid prices | You got it!
CVX | yahoo (18|30) | Not Cached | Saving cache - Got 100% of valid prices | Well done!
CSCO | yahoo (19|30) | Not Cached | Saving cache - Got 100% of valid prices | Looking good!
TRV | yahoo (20|30) | Not Cached | Saving cache - Got 100% of valid prices | Nice!
UNH | yahoo (21|30) | Not Cached | Saving cache - Got 100% of valid prices | Feels good!
GS | yahoo (22|30) | Not Cached | Saving cache - Got 100% of valid prices | Got it!
NKE | yahoo (23|30) | Not Cached | Saving cache - Got 100% of valid prices | Looking good!
V | yahoo (24|30) | Not Cached | Saving cache - Got 100% of valid prices | Good job!
AAPL | yahoo (25|30) | Not Cached | Saving cache - Got 100% of valid prices | OK!
WBA | yahoo (26|30) | Not Cached | Saving cache - Got 100% of valid prices | Well done!
DOW | yahoo (27|30) | Not Cached | Saving cache - Got 30% of valid prices | OUT: not enough data (thresh.bad.data = 100%)
AMGN | yahoo (28|30) | Not Cached | Saving cache - Got 100% of valid prices | Good stuff!
HON | yahoo (29|30) | Not Cached | Saving cache - Got 100% of valid prices | Good stuff!
CRM | yahoo (30|30) | Not Cached | Saving cache - Got 100% of valid prices | Looking good!</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">export</span>(l.out,<span class="st">"l.out.RDS"</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>Datar <span class="ot">&lt;-</span> <span class="fu">unstack</span>(l.out<span class="sc">$</span>df.tickers, l.out<span class="sc">$</span>df.tickers<span class="sc">$</span>ret.adjusted.prices<span class="sc">~</span>l.out<span class="sc">$</span>df.tickers<span class="sc">$</span>ticker)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>Datar <span class="ot">&lt;-</span> Datar[<span class="sc">-</span><span class="dv">1</span>,]</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Split train and testing:</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>train.l <span class="ot">&lt;-</span> <span class="dv">2540</span> <span class="co"># We leave out 500 observations for testing</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust data in a proper way (for OOS error computation and spatio-temporal log ARCH)</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>logDatar2 <span class="ot">&lt;-</span> Datar</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(Datar)) {</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  logDatar2[,i] <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(Datar[,i]<span class="sc">==</span><span class="dv">0</span>, <span class="fu">log</span>(<span class="fu">min</span>(Datar[Datar[,i]<span class="sc">!=</span><span class="dv">0</span>,i]<span class="sc">^</span><span class="dv">2</span>)), <span class="fu">log</span>(Datar[,i]<span class="sc">^</span><span class="dv">2</span>)) </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Define quantities for OOS forecasting:</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>out.l <span class="ot">&lt;-</span> <span class="fu">nrow</span>(Datar) <span class="sc">-</span> train.l <span class="co"># Out of sample length</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Median (solid line) and the 5% and 95% quantiles of the absolute log-returns to depict the temporally varying volatility.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">as.Date</span>(l.out<span class="sc">$</span>df.tickers<span class="sc">$</span>ref.date[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Datar[,<span class="dv">1</span>])]), <span class="fu">apply</span>(<span class="fu">abs</span>(Datar), <span class="dv">1</span>, median), <span class="at">type =</span> <span class="st">"l"</span>, <span class="at">xlab =</span> <span class="st">"Time"</span>, <span class="at">ylab =</span> <span class="st">"Median absolute log-return"</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fl">0.2</span>))</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.Date</span>(l.out<span class="sc">$</span>df.tickers<span class="sc">$</span>ref.date[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Datar[,<span class="dv">1</span>])]),<span class="fu">apply</span>(<span class="fu">abs</span>(Datar), <span class="dv">1</span>, quantile, <span class="fl">0.95</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"grey"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.Date</span>(l.out<span class="sc">$</span>df.tickers<span class="sc">$</span>ref.date[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Datar[,<span class="dv">1</span>])]),<span class="fu">apply</span>(<span class="fu">abs</span>(Datar), <span class="dv">1</span>, quantile, <span class="fl">0.05</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"grey"</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">as.Date</span>(l.out<span class="sc">$</span>df.tickers<span class="sc">$</span>ref.date[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(Datar[,<span class="dv">1</span>])]),<span class="fu">apply</span>(<span class="fu">abs</span>(Datar), <span class="dv">1</span>, quantile, <span class="fl">0.5</span>), <span class="at">lty =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Network_ARCH_GMM_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="network-defintions" class="level2">
<h2 class="anchored" data-anchor-id="network-defintions">Network defintions</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Construct the W matrix: Approach 1</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative A: standard Euclidean distance</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>Wmat1 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">diss</span>(<span class="fu">t</span>(Datar[<span class="dv">1</span><span class="sc">:</span>train.l,]), <span class="st">"EUCL"</span>))</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>Wmat1 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>Wmat1</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat1) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>Wmat1 <span class="ot">&lt;-</span> Wmat1 <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">eigen</span>(Wmat1, <span class="at">only.values =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>values)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative B: correlation-based distance</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>Wmat2 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">diss</span>(<span class="fu">t</span>(Datar[<span class="dv">1</span><span class="sc">:</span>train.l,]), <span class="st">"COR"</span>))</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>Wmat2 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>Wmat2</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat2) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>Wmat2 <span class="ot">&lt;-</span> Wmat2 <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">eigen</span>(Wmat2, <span class="at">only.values =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>values)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative C: log-ARCH approach</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>Wmat3 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">diss</span>(<span class="fu">t</span>(logDatar2[<span class="dv">1</span><span class="sc">:</span>train.l,]), <span class="st">"AR.PIC"</span>))</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>Wmat3 <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">/</span>Wmat3</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat3) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>Wmat3 <span class="ot">&lt;-</span> Wmat3 <span class="sc">/</span> <span class="fu">max</span>(<span class="fu">eigen</span>(Wmat3, <span class="at">only.values =</span> <span class="cn">TRUE</span>)<span class="sc">$</span>values)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Approach 2: k-nearest neighbours</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative A: standard Euclidean distance</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>dist_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">diss</span>(<span class="fu">t</span>(Datar[<span class="dv">1</span><span class="sc">:</span>train.l,]), <span class="st">"EUCL"</span>))</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># Choose 3, 5 or 10</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>Wmat1_3    <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(dist_mat), <span class="cf">function</span>(i) <span class="fu">ifelse</span>(dist_mat[i,] <span class="sc">&lt;</span> <span class="fu">sort</span>(dist_mat[i,])[k<span class="sc">+</span><span class="dv">2</span>] <span class="sc">&amp;</span> dist_mat[i,] <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>k, <span class="dv">0</span>))) <span class="co"># k+2, because of the diagonal zero entry and the strict inequality</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat1_3) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># Choose 3, 5 or 10</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>Wmat1_5    <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(dist_mat), <span class="cf">function</span>(i) <span class="fu">ifelse</span>(dist_mat[i,] <span class="sc">&lt;</span> <span class="fu">sort</span>(dist_mat[i,])[k<span class="sc">+</span><span class="dv">2</span>] <span class="sc">&amp;</span> dist_mat[i,] <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>k, <span class="dv">0</span>))) <span class="co"># k+2, because of the diagonal zero entry and the strict inequality</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat1_5) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># Choose 3, 5 or 10</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>Wmat1_10    <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(dist_mat), <span class="cf">function</span>(i) <span class="fu">ifelse</span>(dist_mat[i,] <span class="sc">&lt;</span> <span class="fu">sort</span>(dist_mat[i,])[k<span class="sc">+</span><span class="dv">2</span>] <span class="sc">&amp;</span> dist_mat[i,] <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>k, <span class="dv">0</span>))) <span class="co"># k+2, because of the diagonal zero entry and the strict inequality</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat1_10) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative B: correlation-based distance</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>dist_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">diss</span>(<span class="fu">t</span>(Datar[<span class="dv">1</span><span class="sc">:</span>train.l,]), <span class="st">"COR"</span>))</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># Choose 3, 5 or 10</span></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>Wmat2_3    <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(dist_mat), <span class="cf">function</span>(i) <span class="fu">ifelse</span>(dist_mat[i,] <span class="sc">&lt;</span> <span class="fu">sort</span>(dist_mat[i,])[k<span class="sc">+</span><span class="dv">2</span>] <span class="sc">&amp;</span> dist_mat[i,] <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>k, <span class="dv">0</span>))) <span class="co"># k+2, because of the diagonal zero entry and the strict inequality</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat2_3) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># Choose 3, 5 or 10</span></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>Wmat2_5    <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(dist_mat), <span class="cf">function</span>(i) <span class="fu">ifelse</span>(dist_mat[i,] <span class="sc">&lt;</span> <span class="fu">sort</span>(dist_mat[i,])[k<span class="sc">+</span><span class="dv">2</span>] <span class="sc">&amp;</span> dist_mat[i,] <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>k, <span class="dv">0</span>))) <span class="co"># k+2, because of the diagonal zero entry and the strict inequality</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat2_5) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># Choose 3, 5 or 10</span></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>Wmat2_10    <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(dist_mat), <span class="cf">function</span>(i) <span class="fu">ifelse</span>(dist_mat[i,] <span class="sc">&lt;</span> <span class="fu">sort</span>(dist_mat[i,])[k<span class="sc">+</span><span class="dv">2</span>] <span class="sc">&amp;</span> dist_mat[i,] <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>k, <span class="dv">0</span>))) <span class="co"># k+2, because of the diagonal zero entry and the strict inequality</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat2_10) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternative C: log-ARCH approach</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>dist_mat <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">diss</span>(<span class="fu">t</span>(logDatar2[<span class="dv">1</span><span class="sc">:</span>train.l,]), <span class="st">"AR.PIC"</span>))</span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># Choose 3, 5 or 10</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>Wmat3_3    <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(dist_mat), <span class="cf">function</span>(i) <span class="fu">ifelse</span>(dist_mat[i,] <span class="sc">&lt;</span> <span class="fu">sort</span>(dist_mat[i,])[k<span class="sc">+</span><span class="dv">2</span>] <span class="sc">&amp;</span> dist_mat[i,] <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>k, <span class="dv">0</span>))) <span class="co"># k+2, because of the diagonal zero entry and the strict inequality</span></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat3_3) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># Choose 3, 5 or 10</span></span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>Wmat3_5    <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(dist_mat), <span class="cf">function</span>(i) <span class="fu">ifelse</span>(dist_mat[i,] <span class="sc">&lt;</span> <span class="fu">sort</span>(dist_mat[i,])[k<span class="sc">+</span><span class="dv">2</span>] <span class="sc">&amp;</span> dist_mat[i,] <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>k, <span class="dv">0</span>))) <span class="co"># k+2, because of the diagonal zero entry and the strict inequality</span></span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat3_5) <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">5</span> <span class="co"># Choose 3, 5 or 10</span></span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>Wmat3_10    <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(dist_mat), <span class="cf">function</span>(i) <span class="fu">ifelse</span>(dist_mat[i,] <span class="sc">&lt;</span> <span class="fu">sort</span>(dist_mat[i,])[k<span class="sc">+</span><span class="dv">2</span>] <span class="sc">&amp;</span> dist_mat[i,] <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span><span class="sc">/</span>k, <span class="dv">0</span>))) <span class="co"># k+2, because of the diagonal zero entry and the strict inequality</span></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Wmat3_10) <span class="ot">&lt;-</span> <span class="dv">0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="network-plots" class="level2">
<h2 class="anchored" data-anchor-id="network-plots">Network plots</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"igraph"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'igraph'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:dplyr':

    as_data_frame, groups, union</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    decompose, spectrum</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:base':

    union</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"wesanderson"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"classInt"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Symmetric network definition</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>names <span class="ot">&lt;-</span> <span class="fu">names</span>(Datar)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># create a network object</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>network <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">from =</span> names[<span class="fu">which</span>(Wmat1 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[,<span class="dv">1</span>]],</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">to =</span> names[<span class="fu">which</span>(Wmat1 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[,<span class="dv">2</span>]]</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">&lt;-</span> <span class="fu">which</span>(Wmat1 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> <span class="fu">graph</span>(<span class="at">edges=</span><span class="fu">as.vector</span>(<span class="fu">t</span>(edges)), <span class="at">n =</span> <span class="fu">dim</span>(Wmat1)[<span class="dv">1</span>], <span class="at">directed =</span> <span class="cn">FALSE</span>) </span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>classes <span class="ot">&lt;-</span> <span class="fu">classIntervals</span>(Wmat1[edges], <span class="dv">8</span>)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="fu">E</span>(g1)<span class="sc">$</span>color <span class="ot">&lt;-</span> <span class="fu">findColours</span>(classes, <span class="at">pal =</span> <span class="fu">gray</span>(<span class="fu">seq</span>(<span class="fl">0.9</span>, <span class="fl">0.1</span>, <span class="at">length =</span> <span class="dv">9</span>)))</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(g1)<span class="sc">$</span>label <span class="ot">&lt;-</span> names</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(g1)<span class="sc">$</span>color <span class="ot">&lt;-</span> <span class="fu">wes_palette</span>(<span class="st">"FantasticFox1"</span>, <span class="dv">29</span>, <span class="at">type =</span> <span class="st">"continuous"</span>)</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(g1, <span class="at">layout =</span> <span class="fu">layout_with_mds</span>(g1, <span class="at">dist =</span> dist_mat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Network_ARCH_GMM_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Directed network definition</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>names <span class="ot">&lt;-</span> <span class="fu">names</span>(Datar)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>      <span class="co"># create a network object</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>network <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">from =</span> names[<span class="fu">which</span>(Wmat1_5 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[,<span class="dv">1</span>]],</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">to =</span> names[<span class="fu">which</span>(Wmat1_5 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)[,<span class="dv">2</span>]]</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>edges <span class="ot">&lt;-</span> <span class="fu">which</span>(Wmat1_5 <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="at">arr.ind =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> <span class="fu">graph</span>(<span class="at">edges=</span><span class="fu">as.vector</span>(<span class="fu">t</span>(edges)), <span class="at">n =</span> <span class="fu">dim</span>(Wmat1_5)[<span class="dv">1</span>], <span class="at">directed =</span> <span class="cn">TRUE</span>) </span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(g1)<span class="sc">$</span>label <span class="ot">&lt;-</span> names</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="fu">V</span>(g1)<span class="sc">$</span>color <span class="ot">&lt;-</span> <span class="fu">wes_palette</span>(<span class="st">"FantasticFox1"</span>, <span class="dv">29</span>, <span class="at">type =</span> <span class="st">"continuous"</span>)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(g1, <span class="at">layout =</span> <span class="fu">layout_with_mds</span>(g1, <span class="at">dist =</span> dist_mat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="Network_ARCH_GMM_files/figure-html/unnamed-chunk-5-2.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="estimation-of-the-network-log-arch-model" class="level2">
<h2 class="anchored" data-anchor-id="estimation-of-the-network-log-arch-model">Estimation of the Network log-ARCH model</h2>
<p>Below, we show the estimation of one (arbitrarily selected) network definition (i.e., <code>Wmat1</code>), but the weight matrix can easily be exchanged by the alternative definitions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"parallel"</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">dim</span>(Wmat1)[<span class="dv">1</span>]</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>n.cores <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">2</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>my.cluster <span class="ot">&lt;-</span> parallel<span class="sc">::</span><span class="fu">makeCluster</span>(n.cores, <span class="at">type =</span> <span class="st">"PSOCK"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>doParallel<span class="sc">::</span><span class="fu">registerDoParallel</span>(<span class="at">cl =</span> my.cluster)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="fu">clusterCall</span>(my.cluster, <span class="cf">function</span>() <span class="fu">library</span>(<span class="st">"MASS"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "MASS"      "stats"     "graphics"  "grDevices" "utils"     "datasets" 
[7] "methods"   "base"     

[[2]]
[1] "MASS"      "stats"     "graphics"  "grDevices" "utils"     "datasets" 
[7] "methods"   "base"     

[[3]]
[1] "MASS"      "stats"     "graphics"  "grDevices" "utils"     "datasets" 
[7] "methods"   "base"     

[[4]]
[1] "MASS"      "stats"     "graphics"  "grDevices" "utils"     "datasets" 
[7] "methods"   "base"     

[[5]]
[1] "MASS"      "stats"     "graphics"  "grDevices" "utils"     "datasets" 
[7] "methods"   "base"     

[[6]]
[1] "MASS"      "stats"     "graphics"  "grDevices" "utils"     "datasets" 
[7] "methods"   "base"     </code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>OOSf_netw <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(out.l, <span class="fu">ncol</span>(Datar)))</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>fERR_netw <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(out.l, <span class="fu">ncol</span>(Datar)))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>OOSf_netw <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">j =</span> <span class="dv">1</span><span class="sc">:</span>out.l, <span class="at">.combine =</span> <span class="st">'rbind'</span>) <span class="sc">%dopar%</span> {</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    y_ast <span class="ot">&lt;-</span> <span class="fu">t</span>(logDatar2[j<span class="sc">:</span>(train.l<span class="sc">+</span>j),])</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">&lt;-</span> <span class="fu">GMM_SDPD_2SLS_ARCH_ind_timelags</span>(<span class="at">Y =</span> y_ast, <span class="at">X =</span> <span class="cn">NULL</span>, <span class="at">W =</span> Wmat1, <span class="at">info =</span> <span class="fu">list</span>(<span class="at">ksy =</span> <span class="dv">10</span>, <span class="at">ksx =</span> <span class="dv">10</span>, <span class="at">stl =</span> <span class="dv">0</span>, <span class="at">tl =</span> <span class="dv">1</span>, <span class="at">ted =</span> <span class="dv">0</span>)) <span class="co"># Parameter estimation</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    mu_0_hat <span class="ot">&lt;-</span> <span class="fu">apply</span>(y_ast[,<span class="sc">-</span><span class="fu">ncol</span>(y_ast)] <span class="sc">-</span> model<span class="sc">$</span>theta[<span class="dv">1</span>,<span class="dv">1</span>]<span class="sc">*</span>Wmat1 <span class="sc">%*%</span> y_ast[,<span class="sc">-</span><span class="fu">ncol</span>(y_ast)] <span class="sc">-</span> <span class="fu">array</span>(model<span class="sc">$</span>theta[<span class="dv">2</span><span class="sc">:</span>(n<span class="sc">+</span><span class="dv">1</span>),<span class="dv">1</span>], <span class="at">dim =</span> <span class="fu">dim</span>(y_ast[,<span class="sc">-</span><span class="dv">1</span>])) <span class="sc">*</span> y_ast[,<span class="sc">-</span><span class="dv">1</span>], <span class="dv">1</span>, mean)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="fu">t</span>(<span class="fu">solve</span>(<span class="fu">diag</span>(<span class="fu">ncol</span>(Datar)) <span class="sc">-</span> model<span class="sc">$</span>theta[<span class="dv">1</span>,<span class="dv">1</span>]<span class="sc">*</span>Wmat1) <span class="sc">%*%</span> <span class="fu">t</span>(model<span class="sc">$</span>theta[<span class="dv">2</span><span class="sc">:</span>(n<span class="sc">+</span><span class="dv">1</span>),<span class="dv">1</span>] <span class="sc">*</span> logDatar2[train.l<span class="sc">+</span>j<span class="dv">-1</span>,] <span class="sc">+</span> mu_0_hat))) <span class="co"># h=1 forecast</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Evaluating forecasting accuracy: </span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(Datar)){</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  fERR_netw[,i] <span class="ot">&lt;-</span> logDatar2[(train.l<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(Datar),i] <span class="sc">-</span>  OOSf_netw[,i]</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>parallel<span class="sc">::</span><span class="fu">stopCluster</span>(<span class="at">cl =</span> my.cluster)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="co"># RMSFE</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(fERR_netw, <span class="dv">2</span>, <span class="cf">function</span>(x){<span class="fu">mean</span>(x<span class="sc">^</span><span class="dv">2</span>)})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1]  5.829756  7.333308  5.928997  7.142860  6.147388  6.377980  5.439136
 [8]  6.206917  6.406684  5.813526  5.362529  6.136303  5.218932  6.394205
[15]  7.496512  5.772788  5.823854  5.657490  6.984077  7.466566  7.031471
[22]  5.553102  5.733041  4.889882  6.202686  5.148704 12.890554  6.143807
[29]  6.341182</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># MAE</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(fERR_netw, <span class="dv">2</span>, <span class="cf">function</span>(x){<span class="fu">mean</span>(<span class="fu">abs</span>(x))})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] 1.895646 2.023808 1.877139 2.069727 1.889369 1.913265 1.751437 1.935957
 [9] 1.985335 1.796383 1.792669 1.860041 1.686777 1.928230 1.823439 1.829085
[17] 1.775743 1.814592 1.935484 2.060802 1.979339 1.812025 1.820570 1.710263
[25] 1.804932 1.735696 2.805025 1.904352 1.929011</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>